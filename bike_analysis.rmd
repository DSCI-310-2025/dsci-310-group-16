---
title: "Predicting Bike Rental Demand Using Regression Analysis"
author: "Annmarie Thomson, Arya Sardesai, Christina Zhang"
date: "2025-1-3"
output: github_document
---

```{r}
set.seed(2024)
library(vroom)
library(tidyverse)
library(tidymodels)
library(ggplot2)
library(ucimlrepo)
library(leaps)
library(mltools)
library(ggpubr)
```

## Predicting Bike Rental Demand Using Regression Analysis

### Summary

### Introduction

-   provide some relevant background information on the topic so that someone unfamiliar with it will be prepared to understand the rest of your report

-   clearly state the question you tried to answer with your project

-   identify and describe the dataset that was used to answer the question

### Methods and Results

```{r read and clean data}
bike <- fetch_ucirepo(id = 275)
bike_data <- bike$data$original
bike_data <- bike_data %>%
  select(-instant, -dteday)
bike_data <- bike_data %>%
  mutate(weathersit = as.factor(weathersit))
bike_data <- bike_data %>%
  mutate(cnt = as.numeric(cnt))
write_csv(bike_data, "../dsci-310-group-16/data/bike_data.csv")
```

```{r exploratory analysis}
summary(bike_data)
head(bike_data)
sum(is.na(bike_data))

total_rentals = ggplot(bike_data,aes(x = cnt))+
geom_histogram(binwidth = 10, fill = "blue",color = "black",alpha = 0.7)+
labs(title = "Histogram of the total bike rentals", x = "Total rentals")

cor(bike_data %>% select(temp, atemp, hum, windspeed, casual, registered, cnt))

temp_vs_rentals = ggplot(bike_data, aes(x = temp, y = cnt)) +
  geom_point(color = "blue", alpha = 0.5) +
  theme_minimal() +
  labs(title = "Temperature vs Bike Rentals", x = "Temperature", y = "Total Bike Rentals")


weather_vs_cnt = ggplot(bike_data, aes(x = factor(weathersit), y = cnt, fill = factor(weathersit))) +
  geom_bar(stat = "identity") +
  scale_x_discrete(labels=c("Clear/Partly Cloudy", "Mist and Cloudy", "Light Percipitation", "Heavy Percipitation")) +
  labs(title = "Bike Rentals by Weather Situation", x = "Weather Situation", y = "Total Bike Rentals") +
  theme_minimal()


season_vs_cnt = ggplot(bike_data, aes(x = factor(season), y = cnt)) +
  geom_boxplot(fill = "lightgreen", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Bike Rentals by Season", x = "Season", y = "Total Bike Rentals")

weekday_rental = ggplot(bike_data, aes(x = factor(weekday), y = cnt, fill = factor(weekday))) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_fill_viridis_d() +
  scale_x_discrete(labels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")) +
  labs(title = "Bike Rentals by Weekday", x = "Weekday", y = "Total Bike Rentals") +
  theme_minimal()

humidty_rental = ggplot(bike_data, aes(x = hum, y = cnt)) +
  geom_point(color = "purple", alpha = 0.5) +
  theme_minimal() +
  labs(title = "Humidity vs Bike Rentals", x = "Humidity", y = "Total Bike Rentals")

wind_rental = ggplot(bike_data, aes(x = windspeed, y = cnt)) +
  geom_point(color = "green", alpha = 0.5) +
  theme_minimal() +
  labs(title = "Windspeed vs Bike Rentals", x = "Wind Speed", y = "Total Bike Rentals")

options(repr.plot.width=12)
ggarrange(temp_vs_rentals, weather_vs_cnt, season_vs_cnt, weekday_rental, humidty_rental, wind_rental)
total_rentals
```

```{r best subset}
bike_split <- initial_split(bike_data, prop = 0.75, strata = cnt)
bike_train <- training(bike_split)
bike_test <- testing(bike_split)

bike_train_summary <- bike_train |> 
    summarize(median_cnt = median(cnt, na.rm = TRUE),
             mean_cnt = mean(cnt, na.rm = TRUE),
             standard_deviation_cnt = sd(cnt, na.rm = TRUE))

bike_test_summary <- bike_test |> 
    summarize(median_cnt = median(cnt, na.rm = TRUE),
             mean_cnt = mean(cnt, na.rm = TRUE),
             standard_deviation_cnt = sd(cnt, na.rm = TRUE))

bike_tt_summary <- bind_rows(bike_train_summary, bike_test_summary) |>
    mutate(partition = c("Train", "Test"),
           fraction = c(0.8, 0.2))|> 
    relocate(partition, fraction)

best_models <- regsubsets(log(cnt)~ season + holiday + workingday + weathersit + temp + hum + windspeed, data = bike_train, nvmax = 11)

res.sum <- summary(best_models)
res.sum

data.frame(
  R2 = which.max(res.sum$rsq),
  Adj.R2 = which.max(res.sum$adjr2)
)
```

```{r}
bike_model_with_weather = lm(log(cnt) ~ season + holiday + workingday + weathersit + temp + hum + windspeed, data = bike_train)
res_with <- summary(bike_model_with_weather)
bike_model_no_weather = lm(log(cnt) ~ season + holiday + workingday + temp + hum + windspeed, data = bike_train)
res_no <- summary(bike_model_no_weather)
data.frame(
  Adj.R2_with = res_with$adj.r.squared,
  Adj.R2_without = res_no$adj.r.squared
)
final_bike_model = bike_model_with_weather
tidy(final_bike_model)
```

```{r test final model}
ggplot(bike_train,aes(x= fitted(final_bike_model),y = residuals(final_bike_model)))+
geom_point(alpha = 0.5)+
geom_hline(yintercept = 0,linetype = 'dashed',color = "red")+
labs(title = "Residual plot", x = "Fitted values", y = "Residuals")

predictions = predict(final_bike_model, newdata = bike_test)
RMSE = rmse(preds = predictions, actuals = log(bike_test$cnt))
RMSE
```
